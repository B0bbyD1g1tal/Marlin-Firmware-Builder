#!/bin/bash
###############################################################################
set -e
set -x
###############################################################################
BINARY_FILE_NAME=$(echo "$MODEL" | tr -d " ")-"${BOARD}"-"${GIT_BRANCH}"-$(date +"%d-%b-%y").bin
###############################################################################
#  Set git-branch
###############################################################################
current-branch="$(git rev-parse --abbrev-ref HEAD)"
#if [ current-branch != GIT_BRANCH ]; then
git checkout "${GIT_BRANCH}"
###############################################################################
#  Manufacturer & Printer & Board selection
###############################################################################
cp \
  "${WORK_DIR}"/Configurations/config/examples/"${MANUFACTURER}"/"${MODEL}"/"${BOARD}"/*.h \
  "${WORK_DIR}"/Marlin/Marlin/
###############################################################################
# Build firmware-*.bin
###############################################################################
cd "${WORK_DIR}"/Marlin/ || exit &&
  pio run -e "${PIO_BOARD}"
###############################################################################
# Copy firmware-*.bin to delivery folder
###############################################################################
cp "${WORK_DIR}"/Marlin/.pio/build/"${PIO_BOARD}"/firmware-*bin \
  "${FIRMWARE_BIN_DIR}"/"${BINARY_FILE_NAME}"
###############################################################################
